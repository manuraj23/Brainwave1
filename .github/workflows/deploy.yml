name: CI/CD - Deploy BRAINWAVE

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      TF_WORKDIR: terraform

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Build React (optional local build for Docker)
      working-directory: .
      run: |
        npm ci
        npm run build || true

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build Docker image
      run: |
        IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/brainwave-react:latest"
        docker build -t $IMAGE -f docker/Dockerfile .
        echo "image=$IMAGE" >> $GITHUB_OUTPUT
      id: build_image

    - name: Push Docker image to Docker Hub
      run: |
        IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/brainwave-react:latest"
        docker push $IMAGE

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.5.0

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    # - name: Terraform Init & Apply
    #   working-directory: ./terraform
    #   env:
    #     TF_VAR_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
    #   run: |
    #     terraform init -input=false
    #     terraform apply -auto-approve -input=false
    - name: Terraform Init, Import Key (if exists) & Apply
      working-directory: ./terraform
      env:
        TF_VAR_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
      run: |
        terraform init -input=false -no-color
        terraform import aws_key_pair.deployer react || true
        terraform apply -auto-approve -input=false -no-color

    # - name: Get Terraform outputs (public IP)
    #   working-directory: ./terraform
    #   id: tf_outputs
    #   run: |
    #     terraform output -raw public_ip > public_ip.txt
    #     echo "PUBLIC_IP=$(cat public_ip.txt)" >> $GITHUB_OUTPUT

    - name: Get Terraform outputs (public IP & instance id)
      working-directory: ./terraform
      id: tf_outputs
      run: |
        # Use -raw but guard against stray debug lines by taking the first non-empty line
        PUBLIC_IP=$(terraform output -raw public_ip 2>/dev/null | sed -n '1p' | tr -d '\r')
        INSTANCE_ID=$(terraform output -raw instance_id 2>/dev/null | sed -n '1p' | tr -d '\r')
        if [ -z "$PUBLIC_IP" ]; then
          echo "Failed to read PUBLIC_IP from terraform output" >&2
          terraform output
          exit 1
        fi
        echo "PUBLIC_IP=$PUBLIC_IP" >> $GITHUB_OUTPUT
        echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_OUTPUT
    

    - name: Create Ansible inventory (dynamic)
      run: |
        mkdir -p .ansible
        echo "[app]" > .ansible/inventory.ini
        echo "${{ steps.tf_outputs.outputs.PUBLIC_IP }} ansible_user=${{ secrets.SSH_USER }} ansible_ssh_private_key_file=./.ansible/id_rsa ansible_python_interpreter=/usr/bin/python3" >> .ansible/inventory.ini
        chmod 600 .ansible/inventory.ini

    - name: Add SSH private key (for Ansible)
      run: |
        mkdir -p .ansible
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > .ansible/id_rsa
        chmod 600 .ansible/id_rsa

    - name: Install Ansible
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip sshpass
        pip3 install --user ansible

    - name: Run Ansible playbook to provision instance
      env:
        DOCKER_IMAGE: "${{ secrets.DOCKERHUB_USERNAME }}/brainwave-react:latest"
      run: |
        export PATH=$PATH:$HOME/.local/bin
        ansible-playbook -i .ansible/inventory.ini --ssh-extra-args='-o StrictHostKeyChecking=no' ansible/playbook.yml

    - name: Post-deploy - show public ip
      run: |
        echo "Application should be available at http://${{ steps.tf_outputs.outputs.PUBLIC_IP }}/"

